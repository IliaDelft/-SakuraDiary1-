<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>–°–∞–∫—É—Ä–∞ ‚Äî –¥–Ω–µ–≤–Ω–∏–∫ –ö–ü–¢</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#ffeef6">
  <link rel="icon" type="image/svg+xml" href="favicon.svg">
  <link rel="apple-touch-icon" href="favicon.svg">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;700;800&display=swap&subset=cyrillic-ext" rel="stylesheet">
  <style>
    :root{--bg:#fff8fb;--panel:#ffeef6;--panel-2:#ffe4f0;--ink:#2b2b2b;--muted:#6c6c6c;--brand:#e9a4c4;--brand-2:#d883ab;--line:#f5cfe0;--focus:#c96ea1}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.55 'Manrope',ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .wrap{max-width:1180px;margin:22px auto;padding:0 14px;position:relative}
    .title{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    h1{margin:0;font-weight:800;font-size:clamp(20px,3vw,30px)}
    .muted{color:var(--muted)}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap}
    .btn{appearance:none;border:1px solid var(--brand-2);background:linear-gradient(180deg,var(--brand),var(--brand-2));color:#fff;padding:9px 12px;border-radius:11px;font-weight:800;cursor:pointer}
    .btn.ghost{background:#fff;color:var(--brand-2)}
    input,select,textarea{width:100%;padding:8px 10px;border:1px solid var(--line);border-radius:10px;background:#fff;font-family:inherit}
    input:focus,select:focus,textarea:focus{outline:2px solid var(--focus);outline-offset:1px}
    .grid{display:grid;gap:12px}
    .split{display:grid;gap:14px;grid-template-columns:1.5fr .5fr}
    @media(max-width:980px){.split{grid-template-columns:1fr}}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:14px;box-shadow:0 8px 24px rgba(201,110,161,.08)}
    .table-wrap{overflow:auto}
    table{width:100%;border-collapse:collapse}
    th,td{border:1px solid var(--line);padding:6px;vertical-align:top}
    th{background:var(--panel-2);font-weight:700}
    .center{text-align:center}
    .rte{background:#fff;border:1px solid var(--line);border-radius:14px;min-height:200px;padding:12px}
    .sakura-lite{position:fixed;inset:0;pointer-events:none;z-index:-1}
    .lite{position:absolute;opacity:.35;font-size:18px;animation:fall linear infinite}
    @keyframes fall{0%{transform:translateY(-10vh) rotate(0)}100%{transform:translateY(110vh) rotate(360deg);opacity:0}}
    @media(print){.sakura-lite{display:none}}
    .note{font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
  <div class="sakura-lite" id="sak"></div>

  <div class="wrap">
    <div class="title">
      <h1>üå∏ –°–∞–∫—É—Ä–∞ ‚Äî –¥–Ω–µ–≤–Ω–∏–∫ –ö–ü–¢</h1>
      <div class="toolbar">
        <button class="btn" id="saveBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —á–µ—Ä–Ω–æ–≤–∏–∫</button>
        <button class="btn ghost" id="saveWeekBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–µ–¥–µ–ª—é</button>
        <button class="btn ghost" id="weeksBtn">–ù–µ–¥–µ–ª–∏ ‚§µ</button>
        <button class="btn ghost" onclick="window.print()">–ü–µ—á–∞—Ç—å</button>
        <button class="btn ghost" id="shareBtn">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è —Å—Å—ã–ª–∫–æ–π</button>
      </div>
    </div>

    <p class="muted">–õ–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ + –ø—É–±–ª–∏–∫–∞—Ü–∏—è –ø–æ —Å—Å—ã–ª–∫–µ. –®—Ä–∏—Ñ—Ç ‚Äî Manrope (–∫–∏—Ä–∏–ª–ª–∏—Ü–∞).</p>

    <div class="card grid">
      <div class="grid" style="grid-template-columns:1fr 1fr 1fr">
        <label>–ò–º—è: <input name="name" placeholder="–ò–º—è üëë"></label>
        <label>–î–∞—Ç–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è: <input type="date" name="date"></label>
        <label>–ù–µ–¥–µ–ª—è –Ω–∞—á–∞—Ç–∞: <input type="date" name="week_start"></label>
      </div>

      <div class="split">
        <div class="grid">
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th rowspan="3" class="center">–î–µ–Ω—å</th>
                  <th colspan="4" class="center">–°–∏–ª—å–Ω–æ–µ –ø–æ–±—É–∂–¥–µ–Ω–∏–µ üôè</th>
                  <th colspan="3" class="center">–í—ã—Å—à–∏–π —Ä–µ–π—Ç–∏–Ω–≥ üèÜ</th>
                  <th rowspan="3" class="center">–ù–∞–≤—ã–∫–∏ 0‚Äì7</th>
                </tr>
                <tr>
                  <th class="center">–∫ —Å—É–∏—Ü–∏–¥—É</th>
                  <th class="center">–∫ —Å–∞–º–æ–ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏—é</th>
                  <th class="center">–∫ –ø—Ä–∏—ë–º—É –≤–µ—â–µ—Å—Ç–≤</th>
                  <th class="center">–∫ –∞–≥—Ä–µ—Å—Å–∏–∏</th>
                  <th class="center">–æ–ø—É—Å—Ç–æ—à—ë–Ω–Ω–æ—Å—Ç—å</th>
                  <th class="center">—Ñ–∏–∑. —É—Å—Ç–∞–ª–æ—Å—Ç—å</th>
                  <th class="center">—Ä–∞–¥–æ—Å—Ç—å</th>
                </tr>
                <tr>
                  <th class="center note">0‚Äì5</th>
                  <th class="center note">0‚Äì5</th>
                  <th class="center note">0‚Äì5</th>
                  <th class="center note">0‚Äì5</th>
                  <th class="center note">0‚Äì5</th>
                  <th class="center note">0‚Äì5</th>
                  <th class="center note">0‚Äì5</th>
                </tr>
              </thead>
              <tbody id="rows-week"></tbody>
            </table>
          </div>

          <div class="grid" style="grid-template-columns:1fr 1fr">
            <label>–ò–∑–º–µ–Ω–µ–Ω–∏–µ –≤ –ø—Ä–∏—ë–º–µ –º–µ–¥–∏–∫–∞–º–µ–Ω—Ç–æ–≤ <textarea name="med_changes" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: ‚Ä¶"></textarea></label>
            <label>–î–ó –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã <textarea name="hw_results" placeholder="–ß—Ç–æ –ø—Ä–æ–±–æ–≤–∞–ª / —á—Ç–æ –ø–æ–ª—É—á–∏–ª–æ—Å—å"></textarea></label>
          </div>
        </div>

        <aside class="grid">
          <div class="card" style="background:#fff">
            <h3>‚≠ê –õ–µ–≥–µ–Ω–¥–∞ –Ω–∞–≤—ã–∫–æ–≤</h3>
            <div class="note">0 ‚Äî –Ω–µ –¥—É–º–∞–ª; 1 ‚Äî –¥—É–º–∞–ª; 2 ‚Äî —Ö–æ—Ç–µ–ª; 3 ‚Äî –ø—ã—Ç–∞–ª—Å—è; 4 ‚Äî –ø—Ä–∏–º–µ–Ω–∏–ª, –Ω–µ –ø–æ–º–æ–≥–ª–æ; 5 ‚Äî –ø—Ä–∏–º–µ–Ω–∏–ª, –ø–æ–º–æ–≥–ª–æ; 6 ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, –Ω–µ –ø–æ–º–æ–≥–ª–æ; 7 ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, –ø–æ–º–æ–≥–ª–æ.</div>
          </div>
          <div class="card" style="background:#fff">
            <h3>üå∏ –ü–æ–±—É–∂–¥–µ–Ω–∏—è (0‚Äì5)</h3>
            <div class="grid">
              <label>–ë—Ä–æ—Å–∏—Ç—å —Ç–µ—Ä–∞–ø–∏—é <input type="number" min="0" max="5" name="urge_quit"></label>
              <label>–ü—Ä–∏–Ω—è—Ç—å –≤–µ—â–µ—Å—Ç–≤–∞ <input type="number" min="0" max="5" name="urge_substance"></label>
              <label>–£–±–∏—Ç—å —Å–µ–±—è <input type="number" min="0" max="5" name="urge_suicide"></label>
            </div>
          </div>
          <div class="card" style="background:#fff">
            <h3>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –ø—Ä–æ—à–µ–¥—à–µ–π —Å–µ—Å—Å–∏–∏</h3>
            <textarea name="session_comment" placeholder="–ó–∞–º–µ—Ç–∫–∏ –∏ –ø–ª–∞–Ω—ã"></textarea>
          </div>
        </aside>
      </div>

      <div class="grid">
        <h3 style="margin:10px 0 0">üìù –î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ –î–ë–¢</h3>
        <div id="dbtEditor" class="rte" contenteditable="true" placeholder="–ü–∏—à–∏ —Å—é–¥–∞‚Ä¶"></div>
      </div>

      <div class="grid" style="grid-template-columns:1fr 1fr;align-items:center">
        <input id="shareOut" readonly placeholder="—Å—Å—ã–ª–∫–∞ –ø–æ—è–≤–∏—Ç—Å—è —Ç—É—Ç" style="border:1px dashed var(--line);padding:8px;border-radius:10px;background:#fff">
        <button id="resetBtn" class="btn ghost" title="–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë">–û—á–∏—Å—Ç–∏—Ç—å</button>
      </div>
    </div>

    <p class="muted" style="margin-top:12px">–°–¥–µ–ª–∞–Ω–æ —Å –∑–∞–±–æ—Ç–æ–π üå∏ –ú–æ–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ –∏–ª–∏ –¥–µ–ª–∏—Ç—å—Å—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–π —Å—Å—ã–ª–∫–æ–π.</p>
  </div>

  <!-- Supabase –∫–∞–∫ ES-–º–æ–¥—É–ª—å, —á—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å –∫–ª–∏–µ–Ω—Ç -->
  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
    window._createSupabaseClient = createClient;
  </script>

  <script>
    /***** –°–∞–∫—É—Ä–∞-–¥–æ–∂–¥—å *****/
    const sak=document.getElementById('sak'), W=innerWidth, N=14;
    for(let i=0;i<N;i++){
      const s=document.createElement('div');
      s.className='lite'; s.textContent='üå∏';
      s.style.left=(Math.random()*W)+'px';
      s.style.animationDuration=(12+Math.random()*12)+'s';
      s.style.animationDelay=(Math.random()*6)+'s';
      sak.appendChild(s);
    }

    /***** –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã *****/
    const DAYS=["–ü–Ω.","–í—Ç.","–°—Ä.","–ß—Ç.","–ü—Ç.","–°–±.","–í—Å–∫."];
    const STORAGE_KEY='sakura_clean_draft_v2';
    const STORE_PREFIX='sakura_clean_week_';
    const STORE_INDEX='sakura_clean_weeks_index_v1';
    const DBT_KEY='dbt_hw_html';

    /***** –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –ø–æ –¥–Ω—è–º *****/
    const tbody=document.getElementById('rows-week');
    const num=(n,min,max)=>`<input type="number" name="${n}" min="${min}" max="${max}">`;
    DAYS.forEach((d,i)=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <th class="center">${d}</th>
        <td>${num(`urge_suicide_${i}`,0,5)}</td>
        <td>${num(`urge_selfharm_${i}`,0,5)}</td>
        <td>${num(`urge_substances_${i}`,0,5)}</td>
        <td>${num(`urge_aggr_${i}`,0,5)}</td>
        <td>${num(`emptiness_${i}`,0,5)}</td>
        <td>${num(`fatigue_${i}`,0,5)}</td>
        <td>${num(`joy_${i}`,0,5)}</td>
        <td>${num(`skills_${i}`,0,7)}</td>`;
      tbody.appendChild(tr);
    });

    /***** –°–±–æ—Ä/—É—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Å–µ—Ö –ø–æ–ª–µ–π *****/
    const $$=(s,r=document)=>Array.from(r.querySelectorAll(s));
    const $=(s,r=document)=>r.querySelector(s);
    function getAll(){
      const d={};
      $$('input,select,textarea').forEach(el=>{
        if(!el.name) return;
        d[el.name] = el.type==='checkbox' ? !!el.checked : el.value;
      });
      const ed=$("#dbtEditor");
      if (ed) d[DBT_KEY]=ed.innerHTML||'';
      return d;
    }
    function setAll(d){
      if(!d) return;
      $$('input,select,textarea').forEach(el=>{
        if(Object.prototype.hasOwnProperty.call(d, el.name)){
          if(el.type==='checkbox') el.checked=!!d[el.name];
          else el.value=d[el.name];
        }
      });
      const ed=$("#dbtEditor");
      if(ed && d[DBT_KEY]!==undefined) ed.innerHTML=d[DBT_KEY];
    }

    /***** –õ–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ *****/
    function saveLocal(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(getAll())); }
    function loadLocal(){ setAll(JSON.parse(localStorage.getItem(STORAGE_KEY)||'{}')); }
    document.addEventListener('input', saveLocal);
    $('#saveBtn').addEventListener('click', ()=>{ saveLocal(); alert('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –ª–æ–∫–∞–ª—å–Ω–æ üå∏'); });
    $('#resetBtn').addEventListener('click', ()=>{ if(confirm('–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –ø–æ–ª—è?')){ localStorage.removeItem(STORAGE_KEY); location.reload(); }});

    /***** –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–µ–¥–µ–ª–∏ –ª–æ–∫–∞–ª—å–Ω–æ + —Å–ø–∏—Å–æ–∫ –Ω–µ–¥–µ–ª—å *****/
    const idxRead=()=>{ try{return JSON.parse(localStorage.getItem(STORE_INDEX)||'[]');}catch{return []} };
    const idxWrite=v=>localStorage.setItem(STORE_INDEX, JSON.stringify(v));
    const weekId=()=> $('input[name="week_start"]').value || new Date().toISOString().slice(0,10);
    const weekTitle=()=>{ const n=$('input[name="name"]').value||'–ë–µ–∑ –∏–º–µ–Ω–∏'; const ws=$('input[name="week_start"]').value||'‚Äî'; return `${ws} ‚Äî ${n}`; };

    function saveWeek(){
      const id=weekId(); const data=getAll(); const when=new Date().toISOString(); const title=weekTitle();
      localStorage.setItem(STORE_PREFIX+id, JSON.stringify({id,title,when,data}));
      const idx=idxRead(); const ex=idx.find(x=>x.id===id);
      if(ex){ ex.title=title; ex.when=when; } else { idx.unshift({id,title,when}); }
      idxWrite(idx);
      alert('–ù–µ–¥–µ–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ üå∏');
    }
    $('#saveWeekBtn').addEventListener('click', saveWeek);

    (function initWeeksModal(){
      const modal=document.createElement('div');
      modal.innerHTML=`
      <div id="weeksModal" class="modal" style="display:none;position:fixed;inset:0;z-index:50">
        <div class="backdrop" style="position:absolute;inset:0;background:rgba(0,0,0,.28)"></div>
        <div class="card" role="dialog" aria-modal="true" style="max-width:680px;margin:10vh auto;background:var(--panel)">
          <h3 style="margin:0 0 8px">–°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –Ω–µ–¥–µ–ª–∏</h3>
          <div id="weeksEmpty" class="muted" style="display:none">–ü–æ–∫–∞ –Ω–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –Ω–µ–¥–µ–ª—å</div>
          <select id="weeksSelect" size="8" style="width:100%;margin:8px 0"></select>
          <div style="display:flex;gap:8px;justify-content:flex-end">
            <button id="openWeekBtn" class="btn">–û—Ç–∫—Ä—ã—Ç—å</button>
            <button id="deleteWeekBtn" class="btn ghost">–£–¥–∞–ª–∏—Ç—å</button>
            <button id="closeWeeksBtn" class="btn ghost">–ó–∞–∫—Ä—ã—Ç—å</button>
          </div>
        </div>
      </div>`;
      document.body.appendChild(modal);
      const box=modal.firstElementChild;
      function open(){
        const sel=modal.querySelector('#weeksSelect'), empty=modal.querySelector('#weeksEmpty');
        sel.innerHTML='';
        const idx=idxRead();
        empty.style.display=idx.length?'none':'block';
        idx.forEach(w=>{
          const o=document.createElement('option');
          o.value=w.id; o.textContent=`${w.id} ‚Äî ${w.title}`; sel.appendChild(o);
        });
        box.style.display='block';
      }
      function close(){ box.style.display='none'; }
      $('#weeksBtn').addEventListener('click', open);
      modal.querySelector('#closeWeeksBtn').addEventListener('click', close);
      modal.querySelector('.backdrop').addEventListener('click', close);
      modal.querySelector('#openWeekBtn').addEventListener('click', ()=>{
        const id=modal.querySelector('#weeksSelect').value;
        if(!id) return;
        const raw=localStorage.getItem(STORE_PREFIX+id);
        if(!raw) return;
        try{ const {data}=JSON.parse(raw); setAll(data); saveLocal(); close(); }catch{ alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–ø–∏—Å–∏'); }
      });
      modal.querySelector('#deleteWeekBtn').addEventListener('click', ()=>{
        const id=modal.querySelector('#weeksSelect').value; if(!id) return;
        if(!confirm('–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—É—é –Ω–µ–¥–µ–ª—é?')) return;
        localStorage.removeItem(STORE_PREFIX+id);
        const idx=idxRead().filter(w=>w.id!==id); idxWrite(idx); open();
      });
    })();

    /***** –ü—É–±–ª–∏–∫–∞—Ü–∏—è –ø–æ —Å—Å—ã–ª–∫–µ —á–µ—Ä–µ–∑ Supabase *****/
    const SUPA_URL = 'https://jefcwyyxvoihtykizqem.supabase.co';
    const SUPA_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImplZmN3eXl4dm9paHR5a2l6cWVtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk1Mzg0MTksImV4cCI6MjA3NTExNDQxOX0.pw2F9cpmeYBrTdW67_Xcpg4AhVKX2b0osGdngzLBBGI';
    const supabase = window._createSupabaseClient ? window._createSupabaseClient(SUPA_URL, SUPA_KEY) : null;

    $('#shareBtn').addEventListener('click', async ()=>{
      if(!supabase){ alert('Supabase –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω'); return; }
      const payload = getAll();
      const { data, error } = await supabase
        .from('diaries')
        .insert([{ data: payload }])
        .select('id')
        .single();
      if (error || !data) {
        console.error(error); alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞–ø–∏—Å—å üò¢'); return;
      }
      const link = `${location.origin}/share.html?id=${data.id}`;
      const out = $('#shareOut'); if (out) out.value = link;
      try { await navigator.clipboard.writeText(link); } catch(e) {}
      alert('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ üå∏');
    });

    // –ó–∞–≥—Ä—É–∑–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
    loadLocal();
  </script>
</body>
</html>

